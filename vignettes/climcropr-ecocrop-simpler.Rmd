---
title: "Towards a simpler ecocrop model"
author: "Andy South"
date: "`r Sys.Date()`"
#output: rmarkdown::html_vignette
#        fig_caption: yes
#output: pdf_document
output: word_document
#vignette: >
#  %\VignetteIndexEntry{climcropr growth cycles}
#%\VignetteEngine{knitr::rmarkdown}
#%\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=7)

library(tidyverse)
library(stringr)
# library(forcats)
# library(sp) #for maps
# library(tmap) #for maps
library(knitr) #for tables with kable
library(climcropr)
library(raster)
library(rnaturalearth) #for maps
library(dismo) #for ecocrop

# extent object for use in plots
ext <- extent(-180,180,-60,80)

```

### Abstract
It's my opinion that there are flaws within the ecocrop modelling approach and these are not justified by tests against field data. The crop parameters stored within the FAO ecocrop database may still be useful. I suggest that a simpler application of the ecocrop crop parameters would be better justified. I think it would be better to aim for a method that could exclude areas that are definitely unsuitable rather than trying to push to generate suitability values. I have developed some R code to give easier access to the FAO ecocrop parameters and to make it easier to test different approaches to combining them with global climate data.

### Background
The FAO ecocrop database holds data for more than 2500 crops including requirements for temperature, rainfall and soils based upon expert judgement. The ecocrop modelling approach estimates suitability for crops based on temperature and precipitation using these requirements. The ecocrop modelling approach has been implemented in a number of slightly different ways. Ecocrop the modelling is designed to be simpler than other crop models allowing it to be applied to a wider range of crops and situations. However ecocrop the model as implemented in R and Diva-GIS has some aspects that are not well justified.

In summary the ecocrop the modelling approach :
1. Calculates a mean of the minimum and maximum crop growth cycle
2. Rounds this mean (up or down) to the nearest number of months to calculate a 'duration'
3. Finds whether there are 'duration' consecutive months in between the ecocrop temperature limits
4. Finds whether there is a concurrent 'duration' period where the total precipitation is between the ecocrop rainfall requirements of the crop.  

This is a broad summary of the ecocrop model as implemented within the R package dismo and with Diva-GIS.

In addition the model uses 'optimal' temperature and precipitation limits specified in FAO ecocrop to develop an index of suitability per month, the best month and the value of the index in the best month.

Ecocrop the model as implemented in this way has not been well tested against empirical data.

For what is supposed to be a simple modelling approach the method becomes quite tricky and not very transparent.

Firstly it doesn't seem very mechanistic to me that a mean of the minimum and maximum crop growth cycles is used as one of the most influential parameters. For example for maize the minimum and maximum crop growth cycles are 65 days and 365 days which round to 3 months and 12 months. The ecocrop model thus assesses temperatures for a 7 month growth cycle. The figure below shows the minimum and maximum crop growth cycles stored within ecocrop for some important crops.


### length of crop growth cycles from ecocrop
```{r, eval=TRUE, echo=FALSE}

# plot crop cycle min and max 

cropnames <- c('maize','wheat','rice','potato','soya bean','sugarcane')
cr_plot_cycle(cropnames)

```

Secondly the crop parameters as specified in the FAO ecocrop database are necessarily very broad. Whilst they are based on expert judgement they cannot hope to capture all of the processes that influence the suitability of an area for a crop. For thi reason I feel it may be pushing the method too far to develop a suitability value between 0 and 1. I note also that there are few data available to test such an index at a global scale. I feel that a more realistic goal would be to try to predict which areas are definitely not suitable for a crop.

A simpler, more transparent, method could allow us to use both the minimum and maximum growth cycles and to develop predictions of which areas are not suitable for a crop.

The proposed method is : 

1. Use the minimum crop growth cycle to assess whether there is a minimum period within the year within the crop temperature limits that could allow the crop to grow. 
2. Use the maximum crop growth cycle to assess whether there is a period that could allow the crop to get sufficient water. Trials have shown that using either the maximum crop growth cycle to assess temperature or the minimum crop growth cycle to assess rainfall leads to the exclusion of unrealistic areas (e.g. excluding maize from most of Europe).

The base ecocrop predictions have some aspects that also look wrong for example they too predict that maize will not grow in Europe. This is also the problem that Nicole had making predictions far into the future, the ecocrop method of using the mean growing cycle to find time periods without low temperatures was excluding moderately northern latitudes.

The proposed new method predicts that a greater proportion of land is potentially suitable. Indeed it may suggest that too much land is suitable, for example looking at maize predictions in Northern latitudes. However I can't think of another way of mechanistically excluding these areas using the ecocrop data.


As a part of developing this I've developed a series of R functions enabling better access to the ecocrop database and for comparing predictions. I can document these further when we are agreed on the best method to use.

For now I'm keen to establish whether this simpler method is more useful to apply to Nicoles model runs.


```{r, eval=TRUE, echo=FALSE}

# new simpler method for predicting suitability 

#cropnames <- c('maize','wheat','rice','potato','soya bean','sugarcane')
#beware underscore in soya_bean
cropnames <- c('maize','rice','wheat','soya_bean')
#using cr_suit_simpler


#todo create a dataframe to store results that I can then use
#to output a table
dfres <- data.frame( crop=cropnames,
                     simple_true_positive=NA,
                     ecocrop_true_positive=NA)
cropnum <- 0
for( crop in cropnames)
{
  cropnum <- cropnum +1
   
  # this uses st, a raster stack stored in the package containing crop predictions & mirca data
  obs <- subset(st,paste0(crop,'_mirca'))
  
  #compare suitsimp to Mirca
  pred <- subset(st,paste0(crop,'_suitsimp'))
    
  tpos_s <- true_pos(obs,pred)
  dfres$simple_true_positive[cropnum] <- signif(tpos_s,2)
  
  #compare ecocrop to Mirca
  pred <- subset(st,paste0(crop,'_ecocrop'))
  
  tpos_e <- true_pos(obs,pred)
  dfres$ecocrop_true_positive[cropnum] <- signif(tpos_e,2) 
  
  #cat(paste(crop, 'simp:', tpos_s, 'ecocrop:', tpos_e, '\n\n' ))
  
}

kable(dfres)
```

